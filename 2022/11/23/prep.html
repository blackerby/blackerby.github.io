<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>prep.sh and mlr | William Blackerby</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="prep.sh and mlr" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I am an inexperienced shell scripter, but this project provided opportunities to do some productive work with the shell. My workflow starts with running prep.sh, a script that takes 2 or 3 arguments and is explained below." />
<meta property="og:description" content="I am an inexperienced shell scripter, but this project provided opportunities to do some productive work with the shell. My workflow starts with running prep.sh, a script that takes 2 or 3 arguments and is explained below." />
<link rel="canonical" href="https://blackerby.github.io/2022/11/23/prep.html" />
<meta property="og:url" content="https://blackerby.github.io/2022/11/23/prep.html" />
<meta property="og:site_name" content="William Blackerby" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-11-23T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="prep.sh and mlr" />
<script type="application/ld+json">
{"description":"I am an inexperienced shell scripter, but this project provided opportunities to do some productive work with the shell. My workflow starts with running prep.sh, a script that takes 2 or 3 arguments and is explained below.","headline":"prep.sh and mlr","dateModified":"2022-11-23T00:00:00+00:00","url":"https://blackerby.github.io/2022/11/23/prep.html","datePublished":"2022-11-23T00:00:00+00:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blackerby.github.io/2022/11/23/prep.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://blackerby.github.io/feed.xml" title="William Blackerby" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">William Blackerby</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">prep.sh and mlr</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2022-11-23T00:00:00+00:00" itemprop="datePublished">Nov 23, 2022
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I am an inexperienced shell scripter, but this project provided opportunities to do some productive work with the shell.  My workflow starts with running <code class="language-plaintext highlighter-rouge">prep.sh</code>, a script that takes 2 or 3 arguments and is explained below.</p>

<h1 id="shebang">Shebang</h1>
<p>I’m on macOS, so my shebang line references zsh.</p>
<div class="language-zsh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#! /usr/bin/env zsh</span>
</code></pre></div></div>

<h1 id="arguments">Arguments</h1>
<div class="language-zsh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">FILE</span><span class="o">=</span><span class="si">$(</span><span class="nb">realpath</span> <span class="nv">$1</span><span class="si">)</span> <span class="c"># full path to file name. must be pdf</span>
<span class="nv">START</span><span class="o">=</span><span class="nv">$2</span> <span class="c"># starting page of pdf file</span>
<span class="k">if</span> <span class="o">[[</span> <span class="nt">-n</span> <span class="nv">$3</span> <span class="o">]]</span>
<span class="k">then
	</span><span class="nv">FINISH</span><span class="o">=</span><span class="nv">$3</span> <span class="c"># ending page of pdf file</span>
<span class="k">fi</span>
</code></pre></div></div>
<p>Here, I use <code class="language-plaintext highlighter-rouge">realpath</code> to take an argument like <code class="language-plaintext highlighter-rouge">../../74.2.pdf</code> and expand it to its full path.  The first argument, <code class="language-plaintext highlighter-rouge">$1</code>, is should be a path to a PDF file.  <code class="language-plaintext highlighter-rouge">$2</code> should be the page the python script begins processing from, and <code class="language-plaintext highlighter-rouge">$3</code> should be the last page it processes.</p>

<h1 id="processing">Processing</h1>
<div class="language-zsh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># pull metadata into csv and write summaries out to text files</span>
<span class="c"># named following this schema: {congress}_{session}_{bill type}_{bill number}.txt</span>
<span class="k">if</span> <span class="o">[[</span> <span class="nt">-n</span> <span class="nv">$FINISH</span> <span class="o">]]</span>
<span class="k">then
	</span>python3 get_summaries.py <span class="nv">$FILE</span> <span class="nv">$START</span> <span class="nv">$FINISH</span>
<span class="k">else
	</span>python3 get_summaries.py <span class="nv">$FILE</span> <span class="nv">$START</span>
<span class="k">fi</span>
</code></pre></div></div>
<p>If there is no <code class="language-plaintext highlighter-rouge">$3</code>, no worries: we just pass the file path and the start page to the python script.</p>

<div class="language-zsh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># get file's name for name of new directory and iteration purposes</span>
<span class="nv">FILE_BASENAME</span><span class="o">=</span><span class="si">$(</span><span class="nb">basename</span> <span class="nv">$FILE</span> .pdf<span class="si">)</span> 
</code></pre></div></div>
<p>Here, I use <code class="language-plaintext highlighter-rouge">basename</code> with the name of the file and the extension <code class="language-plaintext highlighter-rouge">.pdf</code> to get the basename of the file the script is processing.  This will be used to name the directories created by the script.</p>

<div class="language-zsh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># make new directory and move generated files into it</span>
<span class="k">if</span> <span class="o">[[</span> <span class="nt">-n</span> <span class="nv">$FINISH</span> <span class="o">]]</span>
<span class="k">then
	</span><span class="nv">NEW_DIR</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">FILE_BASENAME</span><span class="k">}</span><span class="s2">_</span><span class="k">${</span><span class="nv">START</span><span class="k">}</span><span class="s2">_</span><span class="k">${</span><span class="nv">FINISH</span><span class="k">}</span><span class="s2">"</span>
<span class="k">else
	</span><span class="nv">NEW_DIR</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">FILE_BASENAME</span><span class="k">}</span><span class="s2">_</span><span class="k">${</span><span class="nv">START</span><span class="k">}</span><span class="s2">"</span>
<span class="k">fi</span>
</code></pre></div></div>
<p>Above, we name the directory that the files generated by the script will be moved into.</p>

<p>Manual processing of the bill summaries pointed out some common OCR errors, so below I run a <code class="language-plaintext highlighter-rouge">sed</code> script to deal with some of those.</p>
<div class="language-zsh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for </span>f <span class="k">in</span> <span class="k">*</span>.<span class="o">{</span>txt,csv<span class="o">}</span>
<span class="k">do
	</span>gsed <span class="nt">-f</span> common_errors.sed <span class="nt">-i</span> <span class="nv">$f</span>
<span class="k">done</span>
</code></pre></div></div>

<p>Here’s what that script looks like:</p>
<div class="language-sed highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">Judiciarv</span><span class="se">\b</span><span class="p">/</span>Judiciary<span class="p">/</span><span class="k">i</span><span class="s">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">Tvdings</span><span class="se">\b</span><span class="p">/</span>Tydings<span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">bv</span><span class="se">\b</span><span class="p">/</span>by<span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">anv</span><span class="se">\b</span><span class="p">/</span>any<span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">denved</span><span class="se">\b</span><span class="p">/</span>derived<span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">m</span><span class="se">\b</span><span class="p">/</span>in<span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">piopose</span><span class="se">\b</span><span class="p">/</span>propose<span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">whioh</span><span class="se">\b</span><span class="p">/</span>which<span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">eto</span><span class="o">.</span><span class="se">\b</span><span class="p">/</span>etc.<span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">wit inn</span><span class="se">\b</span><span class="p">/</span>within<span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">wrorks</span><span class="se">\b</span><span class="p">/</span>works<span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">Lnited</span><span class="se">\b</span><span class="p">/</span>United<span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">solelv</span><span class="se">\b</span><span class="p">/</span>solely<span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">lavs</span><span class="se">\b</span><span class="p">/</span>lays<span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">Armv</span><span class="se">\b</span><span class="p">/</span>Army<span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">iniured</span><span class="se">\b</span><span class="p">/</span>injured<span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">Dedares</span><span class="se">\b</span><span class="p">/</span>Declares<span class="p">/</span><span class="k">i</span><span class="s">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">crcp</span><span class="se">\b</span><span class="p">/</span>crop<span class="p">/</span><span class="k">i</span><span class="s">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">Wilev</span><span class="se">\b</span><span class="p">/</span>Wiley<span class="p">/</span><span class="k">i</span><span class="s">g</span>
<span class="k">s</span><span class="p">/</span><span class="se">\b</span><span class="sr">domestio</span><span class="se">\b</span><span class="p">/</span>domestic<span class="p">/</span><span class="k">i</span><span class="s">g</span>
</code></pre></div></div>
<p>Simple stuff, but it saves some time.</p>

<p>The OCR preserved the typesetting of the lines in the original document, so I run another <code class="language-plaintext highlighter-rouge">sed</code> script to make the lines flow and to replace some of the entities the script brings in and normalize some of the punctuation.</p>
<div class="language-zsh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for </span>f <span class="k">in</span> <span class="k">*</span>.txt
<span class="k">do
	</span>gsed <span class="nt">-i</span>.bak <span class="nt">-Ez</span> <span class="nt">-f</span> clean_lines.sed <span class="nv">$f</span>
<span class="k">done</span>
</code></pre></div></div>

<p>Here’s that script:</p>
<div class="language-sed highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">s</span><span class="p">/</span><span class="sr">- </span><span class="se">\n</span><span class="p">//</span><span class="k">g</span>
<span class="k">s</span><span class="p">/(</span><span class="se">\.</span><span class="sr">:</span><span class="p">)</span><span class="sr"> </span><span class="se">\n</span><span class="p">/</span><span class="se">\1\n\n</span><span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/([^</span><span class="sr">.:</span><span class="p">]</span><span class="sr"> </span><span class="p">)</span><span class="se">\n</span><span class="p">/</span><span class="se">\1</span><span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/(</span><span class="sr">‘‘|’’|“|”</span><span class="p">)/</span>"<span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/[</span><span class="sr">‘’</span><span class="p">]/</span>'<span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/</span><span class="sr">-?— ?</span><span class="p">/</span>--<span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/</span><span class="sr">■</span><span class="p">//</span><span class="k">g</span>
<span class="k">s</span><span class="p">/</span><span class="sr"> </span><span class="p">(</span><span class="sr">#|</span><span class="se">\.</span><span class="sr">+</span><span class="p">)</span><span class="sr"> </span><span class="p">/</span> <span class="p">/</span><span class="k">g</span>
<span class="k">s</span><span class="p">/(</span><span class="se">\w\.</span><span class="p">)</span><span class="se">\.</span><span class="sr">+</span><span class="p">/</span><span class="se">\1</span>.<span class="p">/</span><span class="k">g</span>
</code></pre></div></div>

<h1 id="wrapping-up">Wrapping up</h1>
<p>Finally, I move the files generated by the python script into a directory named after the file and page number(s) the being procssed and then copy that directory and its contents into a backup directory.</p>
<div class="language-zsh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nv">$NEW_DIR</span>
<span class="nb">mv</span> <span class="nv">$FILE_BASENAME</span><span class="k">*</span>.??? <span class="nv">$NEW_DIR</span>
<span class="nb">cp</span> <span class="nt">-R</span> <span class="nv">$NEW_DIR</span> <span class="s2">"</span><span class="k">${</span><span class="nv">NEW_DIR</span><span class="k">}</span><span class="s2">.bak"</span>
</code></pre></div></div>

<h1 id="pasting-metadata">Pasting metadata</h1>
<p>The data entry for this workflow happens in Google Sheets, so I use <a href="https://miller.readthedocs.io" target="_blank" rel="noopener noreferrer">Miller</a> to convert the generated CSV file to TSV for easier pasting into Sheets.  I could probably go back and have the script spit out TSV instead of CSV.</p>
<div class="language-zsh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mlr <span class="nt">--c2t</span> <span class="nt">--headerless-csv-output</span> <span class="nb">cat </span>74_2_<span class="o">{</span>PAGE_NUM<span class="o">}</span>.csv | pbcopy
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">--c2t</code> tells Miller to convert CSV to TSV, and <code class="language-plaintext highlighter-rouge">--headerless-csv-output</code> ignores the first line of the file.</p>

<h1 id="up-next">Up next</h1>
<p>As you can probably tell, this script is really just a harness for the <code class="language-plaintext highlighter-rouge">get_summaries.py</code> script that does the bulk of the work.  That script will be explained in the next post.</p>

  </div>
<a class="u-url" href="/2022/11/23/prep.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">William Blackerby</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">William Blackerby</li>
<li><a class="u-email" href="mailto:wmblackerby@gmail.com">wmblackerby@gmail.com</a></li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/blackerby" target="_blank" rel="noopener noreferrer"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">blackerby</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>William Blackerby's home on the web.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
